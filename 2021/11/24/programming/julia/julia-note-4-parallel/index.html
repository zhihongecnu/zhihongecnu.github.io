<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Julia 学习笔记(四) | 并行计算(预备篇) | 我的学习空间</title><meta name="keywords" content="Julia,Julia-Note"><meta name="author" content="致宏"><meta name="copyright" content="致宏"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Julia 并行计算以及相关工具">
<meta property="og:type" content="article">
<meta property="og:title" content="Julia 学习笔记(四) | 并行计算(预备篇)">
<meta property="og:url" content="http://www.wzhecnu.cn/2021/11/24/programming/julia/julia-note-4-parallel/index.html">
<meta property="og:site_name" content="我的学习空间">
<meta property="og:description" content="Julia 并行计算以及相关工具">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg">
<meta property="article:published_time" content="2021-11-24T03:09:05.000Z">
<meta property="article:modified_time" content="2023-03-27T13:34:45.111Z">
<meta property="article:author" content="致宏">
<meta property="article:tag" content="Julia">
<meta property="article:tag" content="Julia-Note">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.wzhecnu.cn/2021/11/24/programming/julia/julia-note-4-parallel/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/iconfont.css"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Julia 学习笔记(四) | 并行计算(预备篇)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-27 21:34:45'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script>(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();</script><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/RexWzh/PicBed/images_for_blogs/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/guestboard/"><i class="fa-fw far fa-comment-dots"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">我的学习空间</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/guestboard/"><i class="fa-fw far fa-comment-dots"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Julia 学习笔记(四) | 并行计算(预备篇)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发布于</span><time class="post-meta-date-created" datetime="2021-11-24T03:09:05.000Z" title="发布于 2021-11-24 11:09:05">2021-11-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-27T13:34:45.111Z" title="更新于 2023-03-27 21:34:45">2023-03-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Julia 笔记系列：</p>
<ul>
<li>『<a href="/2021/10/18/programming/julia/julia-intro/" title="Julia 基本使用及安装教程">Julia 基本使用及安装教程</a>』</li>
<li>『<a href="/2021/10/18/programming/julia/julia-note-1/" title="Julia 学习笔记(一) | 数据类型和函数">Julia 学习笔记(一) | 数据类型和函数</a>』</li>
<li>『<a href="/2021/10/31/programming/julia/julia-note-2/" title="Julia 学习笔记(二) | 类型，派发与设计模式">Julia 学习笔记(二) | 类型，派发与设计模式</a>』</li>
<li>『<a href="/2021/10/31/programming/julia/julia-note-3/" title="Julia 学习笔记(三) | 广播，性能和模块">Julia 学习笔记(三) | 广播，性能和模块</a>』</li>
<li>『<a href="/2021/11/24/programming/julia/julia-note-4-parallel/" title="Julia 学习笔记(四) | 并行计算(预备篇)">Julia 学习笔记(四) | 并行计算(预备篇)</a>』</li>
<li>『<a href="/2022/02/19/programming/julia/julia-python/" title="Julia 学习笔记(番外) | 从 Python 到 Julia">Julia 学习笔记(番外) | 从 Python 到 Julia</a>』</li>
</ul>
<hr>
<h1>唠唠闲话</h1>
<p>本篇为预备内容，介绍 Julia 的并行计算，内容整理自 <a target="_blank" rel="noopener" href="https://juliaacademy.com/courses">Julia Academic</a> 的<a target="_blank" rel="noopener" href="https://juliaacademy.com/p/parallel-computing">视频课</a>，跳转目录：</p>
<ul>
<li><a href="#api">语言交互</a></li>
<li><a href="#glance">初见并行</a></li>
<li><a href="#metaprogramming">代码实验（元编程）</a></li>
<li><a href="#simd">单指令多数据</a></li>
</ul>
<h2 id="span-id-api-语言交互-span"><span id="api">语言交互</span></h2>
<p>Julia 提供了许多语言的接口，方便语言间的交互。本节以计算求和为例，通过 Julia 提供的交互方式，比对各语言求和运算的效率。顺带介绍 Julia 中调用 C，Python 以及 Python 库的方法。</p>
<h3 id="代码实验">代码实验</h3>
<p>演示使用模块 <code>BenchmarkTools</code> 中的宏 <code>@btime</code> 以及 <code>@benchmark</code>，代码实验在后边一节会继续介绍。</p>
<ol>
<li>
<p>首次使用，需安装模块，在 Julia 中执行：</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Pkg</span><br><span class="line">Pkg.add(<span class="string">&quot;BenchmarkTools&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>或者用 Pkg 模式安装</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">]add BenchmarkTools</span><br></pre></td></tr></table></figure>
<p>然后用 <code>using BenchmarkTools</code> 导入模块。</p>
</li>
<li>
<p>使用 <code>@bitme</code> ，大量重复计算右侧表达式，返回平均时间。表达式很简单时，计算次数约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup></mrow><annotation encoding="application/x-tex">10^6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span>，平均时间纳秒级别，表达式越复杂，计算次数越小。</p>
</li>
<li>
<p><code>@benchmark</code> 统计运算信息，包括：计算次数，最小用时，最大用时，中位数用时，平均用时，以及占用内存等，比如</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> BenchmarkTools</span><br><span class="line">a = rand(<span class="number">10</span>^<span class="number">7</span>) <span class="comment"># 随机数</span></span><br><span class="line"><span class="meta">@benchmark</span> sum($a) <span class="comment"># 获取计算数据</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211126222532.png" alt="20211126222532"></p>
</li>
<li>
<p>新建字典，记录最小用时（单位 ms），并初始化随机数据</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d = <span class="built_in">Dict</span>()</span><br><span class="line">a = rand(<span class="number">10</span>^<span class="number">7</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Julia">Julia</h3>
<ol>
<li>
<p>内置函数最小用时</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bench = <span class="meta">@benchmark</span> sum($a) <span class="comment"># 获取计算数据</span></span><br><span class="line">d[<span class="string">&quot;Julia&quot;</span>] = minimum(bench.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211126223427.png" alt="20211126223427"></p>
</li>
<li>
<p>手写函数 <code>mysum</code> 最小用时</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mysum(A)</span><br><span class="line">    s = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> A</span><br><span class="line">        s += a</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">j_bench_hand = <span class="meta">@benchmark</span> mysum($a)</span><br><span class="line">d[<span class="string">&quot;Julia hand-written&quot;</span>] = minimum(j_bench_hand.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211126223558.png" alt="深度截图_选择区域_20211126223558"></p>
</li>
</ol>
<p>注：内置函数 <code>sum</code> 使用了并行计算，因而比手写版本的 <code>mysum</code> 更快。</p>
<h3 id="C-语言">C 语言</h3>
<ol>
<li>
<p>使用 <code>Libdl</code> 模块，编写 C 语言代码 <code>C_code</code>，并新建临时文件 <code>Clib</code></p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入模块</span></span><br><span class="line"><span class="keyword">using</span> Libdl</span><br><span class="line"><span class="comment"># C 语言代码</span></span><br><span class="line">C_code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    #include &lt;stddef.h&gt;</span></span><br><span class="line"><span class="string">    double c_sum(size_t n, double *X) &#123;</span></span><br><span class="line"><span class="string">        double s = 0.0;</span></span><br><span class="line"><span class="string">        for (size_t i = 0; i &lt; n; ++i) &#123;</span></span><br><span class="line"><span class="string">            s += X[i];</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        return s;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 临时文件</span></span><br><span class="line">Clib = tempname() </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>编译二进制文件</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译二进制文件 .so</span></span><br><span class="line">open(<span class="string">`gcc -fPIC -O3 -msse3 -xc -shared -o <span class="subst">$(Clib * <span class="string">&quot;.&quot;</span> * Libdl.dlext)</span> -`</span>,<span class="string">&quot;w&quot;</span>) <span class="keyword">do</span> f</span><br><span class="line">    print(f,C_code)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>用 <code>ccall</code> 封装函数</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc_sum(X::<span class="built_in">Array</span>&#123;<span class="built_in">Float64</span>&#125;) = <span class="keyword">ccall</span>((<span class="string">&quot;c_sum&quot;</span>, Clib),<span class="built_in">Float64</span>, (<span class="built_in">Csize_t</span>, <span class="built_in">Ptr</span>&#123;<span class="built_in">Float64</span>&#125;),length(X), X)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>最小用时</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c_bench = <span class="meta">@benchmark</span> c_sum($a)</span><br><span class="line">d[<span class="string">&quot;C&quot;</span>] = minimum(c_bench.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211126225108.png" alt="深度截图_选择区域_20211126225108"></p>
</li>
</ol>
<p>C 语言版本和 Julia 的手写版本速度相近，但比 Julia 内置版本要慢，这是因为 Julia 内置的 <code>sum</code> 函数使用了并行计算。</p>
<p>Ps：第2步在命令行调用 <code>gcc</code> 的语法，第3行用 <code>ccall</code> 封装函数，这部分介绍再补充。</p>
<h3 id="Python">Python</h3>
<ol>
<li>
<p>导入模块 <code>PyCall</code> （需安装），使用 <code>pybuiltin</code> 封装函数</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入模块</span></span><br><span class="line"><span class="keyword">using</span> PyCall</span><br><span class="line"><span class="comment"># 调用 Python 内置函数</span></span><br><span class="line">pysum = pybuiltin(<span class="string">&quot;sum&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>最小用时</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">py_list_bench = <span class="meta">@benchmark</span> $pysum($a)</span><br><span class="line">d[<span class="string">&quot;Python built-in&quot;</span>] = minimum(py_list_bench.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211126225609.png" alt="深度截图_选择区域_20211126225609"></p>
</li>
</ol>
<p><s>不得不说，Python 速度真拉，，，</s></p>
<h3 id="Python-第三方库">Python 第三方库</h3>
<ol>
<li>
<p>安装 <code>Conda</code> 模块，并用 <code>Conda</code> 安装 <code>Numpy</code></p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ]add Conda # 安装 Conda</span></span><br><span class="line"><span class="keyword">using</span> Conda <span class="comment"># 导入模块 Conda</span></span><br><span class="line">Conda.add(<span class="string">&quot;numpy&quot;</span>) <span class="comment"># 安装 Numpy</span></span><br></pre></td></tr></table></figure>
<p>最后一步安装 <code>numpy</code> 要等较长时间</p>
</li>
<li>
<p>使用 <code>pyimport</code> 导入模块</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numpy_sum = pyimport(<span class="string">&quot;numpy&quot;</span>)[<span class="string">&quot;sum&quot;</span>]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>最小用时</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">py_numpy_bench = <span class="meta">@benchmark</span> $numpy_sum($a)</span><br><span class="line">d[<span class="string">&quot;Python numpy&quot;</span>] = minimum(py_numpy_bench.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211126230053.png" alt="深度截图_选择区域_20211126230053"></p>
</li>
</ol>
<p>Numpy 的 <code>sum</code> 和 Julia 内置的 <code>sum</code> 函数计算速度相近，背后也用了并行计算。</p>
<h3 id="汇总比对">汇总比对</h3>
<p>汇总，比对各语言计算效率</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (key, value) <span class="keyword">in</span> sort(collect(d), by=last)</span><br><span class="line">    println(rpad(key, <span class="number">25</span>, <span class="string">&quot;.&quot;</span>), lpad(round(value; digits=<span class="number">1</span>), <span class="number">6</span>, <span class="string">&quot;.&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211126230358.png" alt="深度截图_选择区域_20211126230358"></p>
<p>Ps：这个打印方式有点意思哈哈</p>
<h2 id="span-id-glance-初见并行-span"><span id="glance">初见并行</span></h2>
<h3 id="运算结合律">运算结合律</h3>
<ol>
<li>
<p>函数 <code>mysum</code> 在执行 <code>for</code> 循环时，Julia 严格按 <code>A</code> 中元素顺序做加法</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mysum(A)</span><br><span class="line">    s = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> A</span><br><span class="line">        s += a</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>浮点数运算有精度问题，不同的加法次序带来的精度损失可能不同，因而加法不满足结合律。当使用 <code>for</code> 循环做浮点数加法时，Julia 不希望每次运算给出不同结果，因而没有使用并行加速。</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A = rand(<span class="number">10</span>^<span class="number">6</span>)</span><br><span class="line"><span class="meta">@info</span> <span class="string">&quot;两种求和&quot;</span> mysum(A) sum(A)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128095559.png" alt="深度截图_选择区域_20211128095559"></p>
</li>
<li>
<p>当精度问题无关紧要时，使用宏 <code>@fastmath</code> 告诉 Julia 浮点运算满足结合律，此时调用 <code>for</code> 循环，Julia 便会使用并行计算加速。</p>
</li>
<li>
<p>手写函数 <code>mysum_fast</code></p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mysum_fast(A)</span><br><span class="line">    s = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> A</span><br><span class="line">        <span class="meta">@fastmath</span> s += a</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    s</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>注：宏 <code>@fastmath</code> 将右侧运算替换为更高效的版本，此处将原先不满足结合律的浮点数求和替换为满足结合律的版本。</p>
</li>
<li>
<p>统计最小用时，与内置版本相近</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">j_bench_hand_fast = <span class="meta">@benchmark</span> mysum_fast($a)</span><br><span class="line">d[<span class="string">&quot;Julia hand-written fast&quot;</span>] = minimum(j_bench_hand_fast.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127110654.png" alt="深度截图_选择区域_20211127110654"></p>
</li>
</ol>
<h3 id="分布式">分布式</h3>
<p>现今计算机几乎都有多个核心，上边运算在单核上进行，其他核心闲置，下边用分布式计算，进一步加快运算速度。</p>
<ol>
<li>
<p>导入模块 <code>Distributed</code> 和 <code>DistributedArrays</code> （需安装）并添进程</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入模块</span></span><br><span class="line"><span class="keyword">using</span> Distributed</span><br><span class="line"><span class="keyword">using</span> DistributedArrays</span><br><span class="line"><span class="comment"># 添加进程</span></span><br><span class="line">addprocs(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>初始化，使用宏 <code>@everywhere</code></p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化</span></span><br><span class="line"><span class="meta">@everywhere</span> <span class="keyword">using</span> DistributedArrays</span><br><span class="line"><span class="meta">@sync</span> <span class="meta">@everywhere</span> workers() include(<span class="string">&quot;/opt/julia-1.6.3/etc/julia/startup.jl&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>注意 <code>include</code> 的地址按 Julia 安装路径填写，Linux 用 <code>find</code> 命令确定路径</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">sudo find -name startup.jl</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>用分布式加速内置函数 <code>sum</code>，速度大约快了一倍</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">adist = distribute(a)</span><br><span class="line">j_bench_dist = <span class="meta">@benchmark</span> sum($adist)</span><br><span class="line">d = <span class="built_in">Dict</span>()</span><br><span class="line">d[<span class="string">&quot;Julia 4x built-in&quot;</span>] = minimum(j_bench_dist.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127122452.png" alt="深度截图_选择区域_20211127122452"></p>
</li>
<li>
<p>用分布式加速手写函数，统计最小用时</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手写分布式求和函数</span></span><br><span class="line"><span class="keyword">function</span> mysum_dist(a::DArray)</span><br><span class="line">    r = <span class="built_in">Array</span>&#123;Future&#125;(<span class="literal">undef</span>, length(procs(a)))</span><br><span class="line">    <span class="keyword">for</span> (i, id) <span class="keyword">in</span> enumerate(procs(a))</span><br><span class="line">        r[i] = <span class="meta">@spawnat</span> id sum(localpart(a))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> sum(fetch.(r))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">j_bench_hand_dist = <span class="meta">@benchmark</span> mysum_dist($adist)</span><br><span class="line">d[<span class="string">&quot;Julia 4x hand-written&quot;</span>] = minimum(j_bench_hand_dist.times) / <span class="number">1e6</span></span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127122930.png" alt="深度截图_选择区域_20211127122930"></p>
</li>
<li>
<p>几种方法的最小用时排序</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (key, value) <span class="keyword">in</span> sort(collect(d), by=last)</span><br><span class="line">    println(rpad(key, <span class="number">25</span>, <span class="string">&quot;.&quot;</span>), lpad(round(value; digits=<span class="number">1</span>), <span class="number">6</span>, <span class="string">&quot;.&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127123051.png" alt="深度截图_选择区域_20211127123051"></p>
</li>
</ol>
<p>Ps：分布式的语法后边细讲，这里先了解个大概。</p>
<h2 id="span-id-metaprogramming-代码实验-span"><span id="metaprogramming">代码实验</span></h2>
<h3 id="元编程">元编程</h3>
<p>前边用 <code>@bitme</code> 和 <code>@benchmark</code> 做进代码实验，测试性能；又用 <code>@fastmath</code> 将代码替换为更高效的版本。<code>@xxx</code> 在 Julia 中称为 “宏”，宏背后执行的是将右侧代码当作字符或符号，生成新的代码进行替换，这种编程方式称为<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23856985">元编程</a>（metaprogramming）。</p>
<h3 id="常用宏">常用宏</h3>
<ol>
<li>
<p><code>@show</code> 和 <code>@info</code> 用于打印信息</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@show</span> <span class="number">1.2</span> typeof(<span class="number">1.2</span>)</span><br><span class="line"><span class="meta">@info</span> <span class="string">&quot;数据及其类型&quot;</span> <span class="number">1.2</span> typeof(<span class="number">1.2</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127130713.png" alt="深度截图_选择区域_20211127130713"></p>
</li>
<li>
<p><code>@assert</code> 用于声明，语法为</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@assert &lt;expr&gt; &lt;description&gt;</span><br></pre></td></tr></table></figure>
<p>其中表达式 <code>&lt;expr&gt;</code> 的数据类型为布尔类型，描述部分可省略，例如</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = -<span class="number">1</span></span><br><span class="line"><span class="meta">@assert</span> a &gt; <span class="number">0</span> <span class="string">&quot;a 取值必须大于0&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127131232.png" alt="深度截图_选择区域_20211127131232"></p>
</li>
<li>
<p><code>@macroexpand</code> 查看使用宏后，实际执行的代码，比如</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@macroexpand</span> <span class="meta">@assert</span> a &gt; <span class="number">0</span> <span class="string">&quot;a 取值必须大于0&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127131438.png" alt="深度截图_选择区域_20211127131438"><br>
说明使用宏 <code>@assert</code> 后，代码实际执行了</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> a &gt; <span class="number">0</span></span><br><span class="line">    <span class="literal">nothing</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    Base.throw(Base.<span class="built_in">AssertionError</span>(<span class="string">&quot;a 取值必须大于0&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>@which</code> 查看表达式<strong>头部函数</strong>使用的方法，比如 Julia 的 <code>+</code> 函数定义了 190 种方法，使用 <code>@which</code> 查看表达式具体调用了哪个函数。</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+</span><br><span class="line"><span class="meta">@which</span> <span class="number">1</span> + <span class="number">1</span></span><br><span class="line"><span class="meta">@which</span> <span class="number">1.0</span> + <span class="number">1.0</span></span><br><span class="line"><span class="meta">@which</span> <span class="number">1.0</span> + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211127132203.png" alt="20211127132203"><br>
注记：<br>
- 图中链接指向 GitHub 仓库相应的代码段<br>
- 使用 <code>@which</code> 时，表达式并没有运行，只是检查了派发方式<br>
- 头部函数为表达式最外层的函数，比如 <code>g(f(x))</code> 的头部函数为 <code>g</code></p>
</li>
<li>
<p>宏可以定义自己的语法，比如 <code>@btime</code> 的 <code>$</code> 代表引用，举几个例子</p>
<ul>
<li>前者每次调用，从外部获取 <code>a</code>，增加了内存开销</li>
</ul>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> BenchmarkTools</span><br><span class="line">a = rand(<span class="number">1000</span>,<span class="number">1000</span>)</span><br><span class="line"><span class="comment"># 方法一</span></span><br><span class="line"><span class="meta">@btime</span> sum(a)</span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line"><span class="meta">@btime</span> sum($a)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127134448.png" alt="深度截图_选择区域_20211127134448"></p>
<ul>
<li>前者每次调用将表达式重新计算，后者直接引用</li>
</ul>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@btime</span> sum(a^<span class="number">2</span>)</span><br><span class="line"><span class="meta">@btime</span> sum($(a^<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127133901.png" alt="深度截图_选择区域_20211127133901"></p>
<ul>
<li>一些情况下，两种方法结果可能不同</li>
</ul>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改变量第一个位置</span></span><br><span class="line"><span class="keyword">function</span> f!(a)</span><br><span class="line">    a[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="meta">@btime</span> f!($[<span class="number">1</span>])</span><br><span class="line"><span class="meta">@btime</span> f!([<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127135739.png" alt="深度截图_选择区域_20211127135739"></p>
</li>
</ol>
<!-- Ps：有新认识可以再补充。 -->
<h3 id="代码实验-2">代码实验</h3>
<p>除了前边介绍了 BenchmarkTools 模块的两个宏 <code>@benchmark</code> 和 <code>@btime</code> ，还有几种宏常用语代码实验。掌握这些宏的用法读法，有助于对 Julia 类型系统的理解和使用。</p>
<ol>
<li>
<p><code>@code_warntype</code> 查看代码中的变量类型。比如定义函数 <code>mysum</code> 时，没有声明数据类型，但实际上 Julia 在编译时自动确定了类型：</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mysum(A)</span><br><span class="line">    s = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> A</span><br><span class="line">        s += a</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">a = rand(<span class="number">10</span>^<span class="number">7</span>)</span><br><span class="line"><span class="meta">@code_warntype</span> mysum(a)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211127160438.png" alt="20211127160438"><br>
函数调用前，Julia 已经知道 <code>A</code> 为 <code>Vector&#123;Float64&#125;</code> 类型，<code>s</code> 和 <code>a</code> 为 <code>Float64</code> 类型，以及输出数据（Body） 为 <code>Float64</code> 类型</p>
</li>
<li>
<p>如果类型不稳定，计算速度要慢一倍</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mysum_unstable(A)</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> A</span><br><span class="line">        s += a</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="meta">@btime</span> mysum($a)</span><br><span class="line"><span class="meta">@btime</span> mysum_unstable($a)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211127160905.png" alt="深度截图_选择区域_20211127160905"></p>
</li>
<li>
<p><code>@code_typed</code> 查看代码中的变量类型</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@code_typed</span> optimize=<span class="literal">false</span> mysum(a)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211127164920.png" alt="20211127164920"><br>
几点说明：<br>
- 每行右侧 <code>::xxx</code> 给出变量的类型信息<br>
- 左侧 <code>%k</code> 为第 k 行表达式值的简写<br>
- 底部给出返回值数据类型</p>
</li>
<li>
<p>用 <code>@code_typed</code> 查看类型不稳定时，计算过程中的变量类型</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">real_data = <span class="built_in">Real</span>[a...]</span><br><span class="line"><span class="meta">@code_typed</span> optimize=<span class="literal">false</span> mysum(real_data)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211127165448.png" alt="20211127165448"><br>
类型不确定时，只能使用更低效的方法，计算速度慢</p>
</li>
<li>
<p><code>@profile</code> 查看计算信息</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Profile</span><br><span class="line">a = rand(<span class="number">10</span>^<span class="number">4</span>)</span><br><span class="line">Profile.clear()</span><br><span class="line"><span class="meta">@profile</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">1</span>:<span class="number">10000</span>; mysum(a); <span class="keyword">end</span></span><br><span class="line">Profile.print(maxdepth=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211127170346.png" alt="20211127170346"><br>
每一行中，第一个字段是在此行执行的任何函数中获取的回溯（样本）的数量。第二个字段是文件名和行号，第三个字段是函数名。缩进用于表示函数调用的嵌套序列，缩进越多的行在调用序列中越深。</p>
</li>
<li>
<p><code>@code_llvm</code> 理解 Julia 的运算过程以及类的确定过程（规则比较复杂，初学不深入）</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@code_llvm</span> <span class="number">1</span> + <span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211127170754.png" alt="20211127170754"></p>
</li>
</ol>
<p>延伸，计算中的硬件效应：<a target="_blank" rel="noopener" href="https://meltdownattack.com/">处理器与数据泄露</a>，<a target="_blank" rel="noopener" href="https://discourse.julialang.org/t/psa-microbenchmarks-remember-branch-history/17436">Microbenchmarks</a>。</p>
<h2 id="span-id-simd-单指令多数据-span"><span id="simd">单指令多数据</span></h2>
<p>单指令多数据，Single-instruction, multiple data， 简称 SIMD，有时也称为“向量化”,vectorization。简单说， SIMD 是在一核一线程上, CPU 指令集层面做的“并行”计算，这要求 CPU 支持 <a target="_blank" rel="noopener" href="https://en.wikichip.org/wiki/x86/avx-512">AVX-512</a>，Advanced Vector Extensions 512 。</p>
<p>本节介绍 <code>@simd</code> 用法及注意事项。</p>
<h3 id="例子体会">例子体会</h3>
<p>还是以求和为例，只是改用对索引进行遍历，而不是元素直接遍历。</p>
<ol>
<li>
<p>使用模块，初始化数据</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> BenchmarkTools</span><br><span class="line">A = rand(<span class="number">100_000</span>) <span class="comment"># 数字间的 _ 用于间隔排版</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>手写求和函数</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> simplesum(A)</span><br><span class="line">    result = zero(eltype(A))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> eachindex(A)</span><br><span class="line">        <span class="meta">@inbounds</span> result += A[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>@inbounds</code> 告诉编译器索引不会溢出</p>
</li>
<li>
<p>与内置 <code>sum</code> 比较，速度慢了 9 倍</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@btime</span> simplesum($A)</span><br><span class="line"><span class="meta">@btime</span> sum($A)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128092308.png" alt="深度截图_选择区域_20211128092308"></p>
</li>
<li>
<p>改用 <code>Float32</code> 类型，并将数据长度翻倍，数据总字节数不变</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A32 = rand(<span class="built_in">Float32</span>, length(A)*<span class="number">2</span>)</span><br><span class="line"><span class="meta">@btime</span> simplesum($A32)</span><br><span class="line"><span class="meta">@btime</span> sum($A32);</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128092712.png" alt="深度截图_选择区域_20211128092712"></p>
</li>
<li>
<p>内置函数的计算时间变动不大，而手写函数时间翻倍；原因是内置函数使用并行计算，当数据为 <code>Float32</code> 时，数据字节减半，并行效率增倍，与长度翻倍抵消。而使用 <code>for</code> 循环遍历索引时，Julia 按顺序进行，长度翻倍则运算次数翻倍，时间相应翻倍。</p>
</li>
<li>
<p>手写函数 <code>simdsum</code>，并比对时间</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> simdsum(A)</span><br><span class="line">    result = zero(eltype(A))</span><br><span class="line">    <span class="meta">@simd</span> <span class="keyword">for</span> i <span class="keyword">in</span> eachindex(A)</span><br><span class="line">        <span class="meta">@inbounds</span> result += A[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># 比较时间</span></span><br><span class="line"><span class="meta">@btime</span> simdsum($A)</span><br><span class="line"><span class="meta">@btime</span> simdsum($A32)</span><br><span class="line"><span class="meta">@btime</span> sum($A)</span><br><span class="line"><span class="meta">@btime</span> sum($A32)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128093327.png" alt="深度截图_选择区域_20211128093327"><br>
计算速度与内置 <code>sum</code> 相近，且处理 <code>Float64</code> 数据与处理长度翻倍的 <code>Float32</code> 数据用时相当。</p>
</li>
<li>
<p>还是前边提到的<a href="#glance">结合律问题</a>。前边通过 <code>@fastmath</code> 允许结合律，触发 Julia 的并行计算（向量化计算）；这里则用 <code>@simd</code> 直接告诉 Julia 可以用并行处理，两种方法速度相近。</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@btime</span> simdsum(A)</span><br><span class="line"><span class="meta">@btime</span> mysum(A)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128094708.png" alt="深度截图_选择区域_20211128094708"></p>
</li>
<li>
<p>对满足结合律的运算，Julia 会自动触发向量化，比如整数加法</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">B = rand(<span class="number">1</span>:<span class="number">10</span>, <span class="number">100_000</span>)</span><br><span class="line"><span class="comment"># 不使用 @simd</span></span><br><span class="line"><span class="meta">@btime</span> simplesum($B)</span><br><span class="line"><span class="comment"># 使用 @simd</span></span><br><span class="line"><span class="meta">@btime</span> simdsum($B)</span><br><span class="line"><span class="comment"># 字节减半，长度翻倍</span></span><br><span class="line">B32 = rand(<span class="built_in">Int32</span>(<span class="number">1</span>):<span class="built_in">Int32</span>(<span class="number">10</span>), length(B)*<span class="number">2</span>)</span><br><span class="line"><span class="meta">@btime</span> simplesum($B32)</span><br><span class="line"><span class="meta">@btime</span> simdsum($B32)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128095013.png" alt="深度截图_选择区域_20211128095013"><br>
使用和不使用 <code>@simd</code> 的计算时间基本一致</p>
</li>
<li>
<p>用 <code>@code_llvm</code> 查看是否使用了向量化</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for 循环做整数加法</span></span><br><span class="line"><span class="meta">@code_llvm</span> simplesum(B)</span><br><span class="line"><span class="comment"># for 循环做浮点数加法</span></span><br><span class="line"><span class="meta">@code_llvm</span> simplesum(A)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211128100220.png" alt="20211128100220"><br>
<img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211128100447.png" alt="20211128100447"></p>
</li>
</ol>
<h3 id="注意事项">注意事项</h3>
<p>使用 <code>@doc @simd</code> 查看帮助文档（谷歌翻译）<br>
<img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211128100716.png" alt="20211128100716"></p>
<p>简单说，如果不正确使用 <code>@simd</code> 会带来一些潜在问题。举个例子：</p>
<ol>
<li>
<p>差分函数 <code>diff</code> 用法如下，计算过程分配了内存</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@btime</span> diff([<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128101724.png" alt="深度截图_选择区域_20211128101724"></p>
</li>
<li>
<p>手写函数 <code>diff!</code>，将差分结果放在第一个变量</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> diff!(A, B)</span><br><span class="line">    A[<span class="number">1</span>] = B[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">2</span>:length(A)</span><br><span class="line">        <span class="meta">@inbounds</span> A[i] = B[i] - B[i-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">A = zeros(<span class="built_in">Float32</span>, <span class="number">100_000</span>)</span><br><span class="line">B = rand(<span class="built_in">Float32</span>, <span class="number">100_000</span>)</span><br><span class="line">diff!(A, B)</span><br><span class="line"><span class="comment"># 补上首项元素</span></span><br><span class="line">[B[<span class="number">1</span>];diff(B)] == A <span class="comment"># true</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>比较计算时间，手写版本快了一倍</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@btime</span> diff!($A, $B)</span><br><span class="line"><span class="meta">@btime</span> diff($B)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128102958.png" alt="深度截图_选择区域_20211128102958"></p>
</li>
<li>
<p>现在，将 <code>A</code> 和 <code>B</code> 使用同一段内存，注意这样调用将导致计算结果错误</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Bcopy = copy(B)</span><br><span class="line"><span class="meta">@btime</span> diff!($Bcopy, $Bcopy)</span><br><span class="line"><span class="meta">@btime</span> diff($B)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128103503.png" alt="深度截图_选择区域_20211128103503"></p>
</li>
<li>
<p>计算时间反而更长了，使用 <code>@code_llvm</code> 发现，这是因为 Julia 检查到 <code>A</code> 和 <code>B</code> 使用同一内存，并行计算不安全，因而没有触发向量化</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@code_llvm</span> diff!(A, B)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211128103817.png" alt="20211128103817"></p>
</li>
<li>
<p>使用 <code>@simd ivdep</code> 跳过检查，可以看到计算速度提升了</p>
 <figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> unsafe_diff!(A, B)</span><br><span class="line">    A[<span class="number">1</span>] = B[<span class="number">1</span>]</span><br><span class="line">    <span class="meta">@simd</span> ivdep <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">2</span>:length(A)</span><br><span class="line">        <span class="meta">@inbounds</span> A[i] = B[i] - B[i-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Bcopy = copy(B)</span><br><span class="line"><span class="comment"># 内置版本</span></span><br><span class="line"><span class="meta">@btime</span> diff($B)</span><br><span class="line"><span class="comment"># 同内存版本</span></span><br><span class="line"><span class="meta">@btime</span> diff!($Bcopy,$Bcopy)</span><br><span class="line">Bcopy = copy(B)</span><br><span class="line"><span class="comment"># 同内存，忽略检查版本</span></span><br><span class="line"><span class="meta">@btime</span> unsafe_diff!($Bcopy,$Bcopy)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20211128105435.png" alt="深度截图_选择区域_20211128105435"></p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">致宏</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.wzhecnu.cn/2021/11/24/programming/julia/julia-note-4-parallel/">http://www.wzhecnu.cn/2021/11/24/programming/julia/julia-note-4-parallel/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">文章采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明来自 <a href="http://www.wzhecnu.cn" target="_blank">我的学习空间</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Julia/">Julia</a><a class="post-meta__tags" href="/tags/Julia-Note/">Julia-Note</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" data-sites="weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 请作者喝茶</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/11/server/07-server-name/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/PicBed/picgo/20211212144639.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">服务器教程(四) | 域名相关</div></div></a></div><div class="next-post pull-right"><a href="/2021/11/22/quantum/liang-zi-chuan-shu-yu-mi-yao-fen-fa/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/RexWzh/PicBed@picgo/picgo_folder/20211123005035.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">量子传输与密钥分发 | 量子系列之四</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/18/programming/julia/julia-note-1/" title="Julia 学习笔记(一) | 数据类型和函数"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-18</div><div class="title">Julia 学习笔记(一) | 数据类型和函数</div></div></a></div><div><a href="/2021/10/18/programming/julia/julia-intro/" title="Julia 基本使用及安装教程"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-18</div><div class="title">Julia 基本使用及安装教程</div></div></a></div><div><a href="/2021/10/31/programming/julia/julia-note-3/" title="Julia 学习笔记(三) | 广播，性能和模块"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-31</div><div class="title">Julia 学习笔记(三) | 广播，性能和模块</div></div></a></div><div><a href="/2021/10/31/programming/julia/julia-note-2/" title="Julia 学习笔记(二) | 类型，派发与设计模式"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-31</div><div class="title">Julia 学习笔记(二) | 类型，派发与设计模式</div></div></a></div><div><a href="/2022/07/01/programming/julia/julia-note-6-scrap/" title="Julia 学习笔记(六) | Julia 简易爬虫"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-01</div><div class="title">Julia 学习笔记(六) | Julia 简易爬虫</div></div></a></div><div><a href="/2022/04/23/programming/julia/julia-note-5-package/" title="Julia 学习笔记(五) | 模块开发 - 基础篇"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhihongecnu/WallPapers/julia.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-23</div><div class="title">Julia 学习笔记(五) | 模块开发 - 基础篇</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/RexWzh/PicBed/images_for_blogs/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">致宏</div><div class="author-info__description">Math + Computer = ?</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/RexWzh"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/RexWzh" target="_blank" title="Github"><i class="iconfont icon-github"></i></a><a class="social-icon" href="https://space.bilibili.com/518870168" target="_blank" title="B站"><i class="iconfont icon--bilibili"></i></a><a class="social-icon" href="https://www.zhihu.com/people/wang-zhi-hong-79-21" target="_blank" title="知乎"><i class="iconfont icon-zhihu"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">新功能陆续上线，欢迎交流！干杯！！！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">唠唠闲话</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#span-id-api-%E8%AF%AD%E8%A8%80%E4%BA%A4%E4%BA%92-span"><span class="toc-number">1.1.</span> <span class="toc-text">语言交互</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E9%AA%8C"><span class="toc-number">1.1.1.</span> <span class="toc-text">代码实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Julia"><span class="toc-number">1.1.2.</span> <span class="toc-text">Julia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-%E8%AF%AD%E8%A8%80"><span class="toc-number">1.1.3.</span> <span class="toc-text">C 语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python"><span class="toc-number">1.1.4.</span> <span class="toc-text">Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93"><span class="toc-number">1.1.5.</span> <span class="toc-text">Python 第三方库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E6%80%BB%E6%AF%94%E5%AF%B9"><span class="toc-number">1.1.6.</span> <span class="toc-text">汇总比对</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#span-id-glance-%E5%88%9D%E8%A7%81%E5%B9%B6%E8%A1%8C-span"><span class="toc-number">1.2.</span> <span class="toc-text">初见并行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%AE%97%E7%BB%93%E5%90%88%E5%BE%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">运算结合律</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">分布式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#span-id-metaprogramming-%E4%BB%A3%E7%A0%81%E5%AE%9E%E9%AA%8C-span"><span class="toc-number">1.3.</span> <span class="toc-text">代码实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E7%BC%96%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">元编程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%AE%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text">常用宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E9%AA%8C-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">代码实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#span-id-simd-%E5%8D%95%E6%8C%87%E4%BB%A4%E5%A4%9A%E6%95%B0%E6%8D%AE-span"><span class="toc-number">1.4.</span> <span class="toc-text">单指令多数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BD%93%E4%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">例子体会</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.4.2.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 致宏</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<a href="https://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">粤ICP备2021109780号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'twikoo-8grfz18jfe3c2793',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'twikoo-8grfz18jfe3c2793',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="欢,迎,来,访,你,好,朋,友" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>